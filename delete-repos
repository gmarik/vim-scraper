#!/bin/env ruby

# Mass delete, just pass the names of the repos to delete as args.
#   ./delete-repos spec.vim nlist.vim torte.vim
# Be careful!
#
# TODO: rate limiting hasn't been tested.


require 'rubygems'
require 'bundler'
Bundler.require

require 'octopussy'
require 'json'

creds = Hashie::Mash.new(JSON.parse(File.read('creds.json')))
github = Octopussy::Client.new(creds)

# monkeypatch octopussy because its delete has a bug
Octopussy::Client.class_eval do
    def delete(repo, delete_token={})
        repo = Octopussy::Repo.new(repo)
        response = self.class.post("/repos/delete/#{repo.name}", :query => auth_params, :body => {:delete_token => delete_token})
        Hashie::Mash.new(response)
    end
end

call_count = 0
start = Time.now
ARGV.each do |name|
    result = github.delete(name)
    call_count += 1
    if result
        result = github.delete name, result.delete_token
        call_count += 1
        if result.status == "deleted"
            puts "deleted #{name}"
        else
            puts "Unknown response from second stage for #{name}: #{result}"
        end
    else
        puts "got #{result.inspect} trying to delete #{name}"
    end

    # make sure we don't bump into github's rate limit
    if call_count >= 60
        duration = Time.now - start
        puts "at rate limit, sleeping for #{60 - duration} seconds"
        sleep 60 - duration if duration < 60
        start = Time.now
        call_count = 0
    end
end

